# ==========================
# FastAPI PowerShell Runner
# ==========================
# 자동 가상환경 활성화 + Uvicorn 실행 스크립트
# 작성자: 혜정 전용 Dev Setup

# --- [1] 경로 설정 ---
$projectRoot = Split-Path -Parent $MyInvocation.MyCommand.Path
Set-Location $projectRoot

# --- [2] 가상환경 경로 확인 ---
$venvPath = Join-Path $projectRoot "venv\Scripts\Activate.ps1"
if (-Not (Test-Path $venvPath)) {
    Write-Host "⚠️  가상환경(venv)이 존재하지 않습니다. 새로 생성합니다..." -ForegroundColor Yellow
    python -m venv venv
}

# --- [3] 가상환경 활성화 ---
Write-Host "🐍 가상환경 활성화 중..." -ForegroundColor Cyan
& $venvPath

# --- [4] 의존성 확인 (없으면 자동 설치) ---
if (-Not (Test-Path "$projectRoot\venv\Lib\site-packages\fastapi")) {
    Write-Host "📦 FastAPI, Uvicorn 등 의존성 설치 중..." -ForegroundColor Yellow
    pip install fastapi uvicorn sqlalchemy pydantic python-jose passlib[bcrypt]
}

# --- [5] 서버 실행 ---
Write-Host "🚀 FastAPI 서버를 실행합니다..." -ForegroundColor Green
try {
    python -m uvicorn app.main:app --reload
}
catch {
    Write-Host "❌ 서버 실행 중 오류가 발생했습니다:" $_.Exception.Message -ForegroundColor Red
}

# --- [6] 종료 시 ---
Write-Host "🛑 서버가 종료되었습니다. 가상환경을 비활성화합니다." -ForegroundColor DarkYellow
deactivate
